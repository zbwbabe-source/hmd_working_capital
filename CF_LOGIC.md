# C/F 연동 로직 정리

이 문서는 `app/page.tsx`의 `adjustedCfData` 기준으로, 현재 적용된 현금흐름표(C/F) 시뮬레이션 로직을 정리한 문서다.

## 1) 적용 범위

- 대상 화면: `CF` 뷰
- 대상 연도: `2026`년
- 트리거: 상단 `매출 YoY` 슬라이더(`salesYoYRate`)
- 기준점(Base): `salesYoYRate = 115`일 때 원본 데이터(기준 시나리오)

---

## 2) 전체 흐름

1. 원본 `cfData`를 clone
1. 매출수금(홍콩/대만) 월별 값을 슬라이더에 따라 조정
1. 홍콩마카오 `매장 임차료`를 `고정 최소 + 매출연동 20%` 규칙으로 재계산
1. 물품대 지출(홍콩/대만)을 버퍼로 조정해 현금잔액 기준(115%) 유지
1. 그룹(부모) 행 재합산
1. 연간합계/YoY 재계산
1. 순현금흐름(Net Cash) 재계산
1. 현금잔액(기말잔액) 반영값 표시

---

## 3) 매출수금 연동

경로:
- `영업활동 > 입금 > 매출수금 > 홍콩마카오`
- `영업활동 > 입금 > 매출수금 > 대만`

계산:
- `delta = (salesYoYRate - 115) / 100`
- 홍콩마카오 반영계수: `1 + delta`
- 대만 반영계수: `1 + delta * 0.8`

월별 적용:
- 2월~12월 인덱스(`monthIdx = 1..11`)에 적용
- 변경분(`updated - current`)을 지역별 월간 순증감 배열에 누적
  - `hkNetDeltaByMonth`
  - `twNetDeltaByMonth`

---

## 4) 홍콩마카오 매장 임차료 연동

경로:
- `영업활동 > 지출(또는 비용) > 홍콩마카오 > 매장 임차료`

규칙:
- `고정 최소 임차료 = 기존 임차료 절대값`
- `변동 임차료 = (조정된 홍콩 매출) * 20%`
- `최종 임차료 절대값 = max(고정 최소 임차료, 변동 임차료)`
- 표시값은 지출이므로 음수: `최종 임차료 = -최종 임차료 절대값`

의미:
- 20%가 고정 최소를 넘기 전: 기존 수준 유지
- 넘는 순간: 매출의 20%로 증가

주의:
- 대만 `매장 임차료`는 변경하지 않음(기존 방식 유지)

---

## 5) 물품대 지출 연동 (현금잔액 115% 기준 유지)

목표:
- 슬라이더 변경으로 생긴 지역별 현금 증감을 `물품대 지출`에서 상쇄하여,
  `현금잔액`이 기준 시나리오(115%)와 동일하게 유지되도록 함.

경로:
- `영업활동 > 지출 > 물품대 > 홍콩마카오`
- `영업활동 > 지출 > 물품대 > 대만`

계산:
- 홍콩은 `hkNetDeltaByMonth`(매출+임차료 반영 후 순증감)를 사용
- 대만은 `twNetDeltaByMonth`(매출 반영 순증감)를 사용
- 월별로 `updatedGoodsPayment = currentGoodsPayment - offset`
  - `offset > 0`(현금 증가 요인)일수록 물품대 지출을 더 키워 상쇄
  - `offset < 0`(현금 감소 요인)일수록 물품대 지출을 줄여 상쇄
- 적용 후 `deltaByMonth += diff`를 통해 해당 월 순증감을 0으로 수렴

결과:
- 현금잔액 경로에 전달되는 누적 증감이 최소화되어 기준 현금 수준 유지

---

## 6) 현금잔액/합계 재계산

- 지역별 월간 순증감 배열을 누적으로 변환(`toCumulative`)
- `현금잔액 > 잔액 > 기말잔액 > 홍콩마카오/대만`에 누적값 반영
- 이후 그룹 행은 하위 합으로 재합산
- 각 행의 연간합계(`values[12]`)와 YoY(`values[13]`) 재계산
- `순현금흐름(Net Cash)`은
  - `영업활동 + 자산성지출 + 기타수익`
  으로 다시 계산

---

## 7) 현재 정책 요약

- 매출수금: 홍콩 100%, 대만 80% 민감도
- 임차료: 홍콩만 `고정 최소 vs 매출 20%` 룰 적용
- 대만 임차료: 기존 유지
- 물품대: 지역별로 별도 상쇄(홍콩/대만 동일 비율 강제 아님)

---

## 8) 운전자본표 연동 (매출채권)

적용 배경:
- 운전자본표의 `매출채권`은 실질적으로 `대만 AR`로 운영

적용 범위:
- 대상 연도: `2026`
- 대상 계정: `매출채권 > 대만 ...` 하위 행
- 트리거: `매출 YoY` 슬라이더

계산 규칙:
- 매출 변동률: `delta = (salesYoYRate - 115) / 100`
- 매출채권 반영률: `delta * (1 - 20%) = delta * 0.8`
- 월별 적용값: `기존값 * (1 + delta * 0.8)`

재계산:
- 하위 대만 AR 조정 후 `매출채권(레벨0)`을 하위 합으로 재계산
- `운전자본합계 = 매출채권 + 재고자산 + 매입채무` 재계산
- `전월대비` 행 재계산
- 운전자본표는 시점 데이터 기준으로 `기말(values[12]) = 12월(values[11])`, `YoY(values[13]) = 기말 - 전년기말`

주의:
- 현재 `매출채권(대만)` 연동 외에 `재고자산/매입채무`도 별도 룰로 연동됨(아래 9, 10 참고)

---

## 9) 운전자본표 연동 (재고자산)

적용 배경:
- 재고자산은 매출 변동에 대해 매출원가 수준만큼 반대로 움직이도록 가정
- 매출원가율은 고정 `43%` 사용 (2025년 연간 실적 기준)

적용 범위:
- 대상 연도: `2026`
- 대상 계정: `재고자산` 하위(leaf) 행
- 트리거: `매출 YoY` 슬라이더

계산 규칙:
- 월별 총 매출 증감분(홍콩 + 대만)을 계산
  - 홍콩 매출수금: `1 + delta`
  - 대만 매출수금: `1 + delta * 0.8`
- 재고자산 증감분:
  - `inventoryDelta = -(totalSalesDelta * 0.43)`
  - 매출과 반대방향 반영
    - 매출 증가 시 재고자산 감소
    - 매출 감소 시 재고자산 증가

재계산:
- 하위 재고자산 조정 후 `재고자산(레벨0)` 합산 재계산
- `운전자본합계 = 매출채권 + 재고자산 + 매입채무` 재계산
- `전월대비` 행 재계산
- 운전자본표 `기말/YoY` 재계산 유지

---

## 10) 운전자본표 연동 (매입채무)

적용 배경:
- 매입채무는 C/F의 `물품대 지출` 변화와 연결

적용 범위:
- 대상 연도: `2026`
- 기준 계정: C/F `영업활동 > 지출 > 물품대 > 홍콩마카오/대만`
- 반영 계정: 운전자본표 `매입채무` 하위(leaf) 행

계산 규칙:
- 월별 물품대 증감분:
  - `goodsPaymentDelta = adjustedCFGoodsPayment - baseCFGoodsPayment`
- 월별 매입채무 증감분:
  - `apDelta = -goodsPaymentDelta`
  - 즉, 물품대와 동일금액/반대방향

배분 방식:
- 매입채무 하위가 여러 개인 경우 월별 절대값 비중으로 배분
- 현재 데이터는 하위 1개(`본사 AP(물품대)`)라 해당 항목에 전액 반영

재계산:
- 매입채무 반영 후 `매입채무(레벨0)` 합산 재계산
- `운전자본합계 = 매출채권 + 재고자산 + 매입채무` 재계산
- `전월대비`, `기말/YoY` 재계산 유지

향후 확장:
- 재고자산/매입채무를 `홍콩마카오/대만`으로 분리할 숫자(또는 비율) 수령 후, 지역별 배분 로직으로 확장 예정

---

## 11) 기준 코드 위치

- 파일: `app/page.tsx`
- 블록: `const adjustedCfData = useMemo(() => { ... })`
- 블록: `const adjustedWcStatementData = useMemo(() => { ... })`
